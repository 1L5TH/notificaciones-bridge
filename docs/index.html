<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Activando Alertas...</title>

        <script
            src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"
            defer
        ></script>

        <script>
            // 1. CONFIGURACI칍N
            const myAppId = "d7bc8634-43c9-404c-a6d6-83785049b34e";
            // Reemplaza con la IP de tu servidor donde recibir치s el dato
            const miServidorHttp =
                "http://159.54.143.13:3000/guardar_token.php";

            window.OneSignalDeferred = window.OneSignalDeferred || [];

            OneSignalDeferred.push(async function (OneSignal) {
                // Inicializamos
                await OneSignal.init({
                    appId: myAppId,
                    workerPath: "OneSignalSDKWorker.js",
                    serviceWorkerParam: { scope: "/notificaciones-bridge/" },
                    serviceWorkerPath: "OneSignalSDKWorker.js",
                    // Forzamos el registro del scope para que sepa que opera en la subcarpeta
                    scope: "/notificaciones-bridge/",
                    path: "/notificaciones-bridge/",
                });

                console.log("OneSignal inicializado.");

                // FUNCI칍N PARA REDIRIGIR
                const redirigirAlServer = (userId) => {
                    if (userId) {
                        console.log("Token encontrado:", userId);
                        document.getElementById("status").innerText =
                            "춰Listo! Redirigiendo...";
                        // Peque침a pausa para asegurar que el usuario vea que funcion칩
                        setTimeout(() => {
                            window.location.href =
                                miServidorHttp + "?token=" + userId;
                        }, 1000);
                    }
                };

                // CASO A: El usuario acepta el permiso por primera vez
                OneSignal.User.PushSubscription.addEventListener(
                    "change",
                    (event) => {
                        if (event.current.optedIn) {
                            // Obtenemos el ID nuevo (Versi칩n 16 syntax)
                            const newId = OneSignal.User.PushSubscription.id;
                            redirigirAlServer(newId);
                        }
                    },
                );

                // CASO B: El usuario ya estaba suscrito de antes
                if (OneSignal.User.PushSubscription.optedIn) {
                    const currentId = OneSignal.User.PushSubscription.id;
                    redirigirAlServer(currentId);
                } else {
                    // Si no est치 suscrito, mostramos la ventanita
                    OneSignal.Slidedown.promptPush();
                }
            });
        </script>
    </head>
    <body>
        <div
            style="
                font-family: sans-serif;
                text-align: center;
                margin-top: 50px;
                padding: 20px;
            "
        >
            <h1>游댒 Activando notificaciones</h1>
            <p id="status">
                Por favor, haz clic en <strong>Permitir</strong> cuando el
                navegador te pregunte.
            </p>
            <div style="margin-top: 20px; color: #666; font-size: 0.9em">
                <p>
                    Si no ves la alerta, revisa que no tengas un bloqueador de
                    anuncios activado.
                </p>
            </div>
        </div>
    </body>
</html>
